<!--
    SPDX-License-Identifier: AGPL-3.0-or-later
    Copyright (C) 2023 Divy Patel
    Copyright (C) 2023-2024 Colin B. Macdonald
    Copyright (C) 2024 Aidan Murphy
    Copyright (C) 2024 Aden Chan
-->
{% extends "base/base.html" %}
{% load static %}
{% load humanize %}
{% block title %}
    Rubric Info - {{ latest_rubric.key }}
{% endblock title %}
{% block page_heading %}
    Rubric Info
{% endblock page_heading %}
{% block main_content %}
    <script>
        function populateFields() {
            updateQuestion();
            updateKind();
        }

        function updateQuestion() {
            var question_dict = JSON.parse('{{ questions|escapejs }}');
            var question = document.getElementById("id_question").value;
            var out_of = question_dict[question]["mark"];
            document.getElementById("id_out_of").value = out_of;
            updateConstraints(out_of);

        }

        function updateKind() {
            var kind = document.getElementById("id_kind").value;
            if (kind === "absolute") {
                document.getElementById("id_out_of_label").innerHTML = "out of";
            } else {
                document.getElementById("id_out_of_label").innerHTML = "Max:";
            }
            updateConstraints(document.getElementById("id_out_of").value);
        }

        function updateConstraints(out_of) {
            var kind = document.getElementById("id_kind").value;
            if (kind === "absolute") {
                document.getElementById("id_value").min = 0;
                document.getElementById("id_value").max = out_of;
            } else if (kind === "relative") {
                document.getElementById("id_value").min = -1 * out_of;
                document.getElementById("id_value").max = out_of;
            } else {
                document.getElementById("id_value").value = 0;
            }
        }
    </script>
    <div class="container m-0">
        <div class="row">
            <div class="col">
                <div class="card">
                    <h5 class="card-header d-flex justify-content-between align-items-center">
                        Rubric {{ latest_rubric.key }}, revision {{ latest_rubric.revision }}
                        <a class="btn btn-outline-primary float-end"
                           data-bs-toggle="modal"
                           data-bs-target="#editModal"
                           onclick="populateFields()">
                            <i class="bi bi-pencil-square"></i>
                            Edit
                        </a>
                    </h5>
                    <div class="card-body">
                        <table class="table">
                            <tbody>
                                <tr>
                                    <th scope="row">Key</th>
                                    <td>{{ latest_rubric.key }}</td>
                                </tr>
                                <tr>
                                    <th scope="row">Question</th>
                                    <td>{{ latest_rubric.question }}</td>
                                </tr>
                                <tr>
                                    <th scope="row">Kind</th>
                                    <td>{{ latest_rubric.kind }}</td>
                                </tr>
                                <tr>
                                    <th scope="row">Created By</th>
                                    <td>{{ latest_rubric.user }}</td>
                                </tr>
                                <tr>
                                    <th scope="row">Last Modified</th>
                                    <td>{{ latest_rubric.last_modified|naturaltime }} by {{ latest_rubric.modified_by_user }}</td>
                                </tr>
                                <tr>
                                    <th scope="row">System Rubric</th>
                                    <td>{{ latest_rubric.system_rubric }}</td>
                                </tr>
                                <tr>
                                    <th scope="row">Used</th>
                                    <td>
                                        {{ marking_tasks|length }}
                                        {% if marking_tasks|length == 1 %}
                                            time
                                        {% else %}
                                            times
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th scope="row">Preview</th>
                                    <td>{{ latest_rubric_as_html|safe }}</td>
                                </tr>
                                <tr>
                                    <th scope="row">Meta</th>
                                    <td>{{ latest_rubric.meta }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col">
                {% if revisions %}
                    <div class="card mb-2">
                        <h5 class="card-header">Compare Revisions</h5>
                        <div class="card-body">
                            <form method="post"
                                  class="form-inline"
                                  hx-post="{% url 'compare_rubrics' latest_rubric.key %}"
                                  hx-target="#diff-result"
                                  hx-swap="innerHTML">
                                {% csrf_token %}
                                <label class="sr-only" for="inlineFormInputName2">Compare</label>
                                {{ diff_form.left_compare }}
                                <label for="inlineFormInputGroupUsername2">with</label>
                                {{ diff_form.right_compare }}
                                <button type="submit" class="btn btn-primary">Compare</button>
                            </form>
                            <div id="diff-result"></div>
                        </div>
                    </div>
                {% endif %}
                <div class="card">
                    <h5 class="card-header">Past Revisions</h5>
                    <div class="card-body">
                        <div class="accordion" id="accordion">
                            {% for revision in revisions reversed %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading-{{ forloop.counter }}">
                                        <button class="accordion-button collapsed"
                                                type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#collapse-{{ forloop.counter }}"
                                                aria-expanded="false"
                                                aria-controls="collapse-{{ forloop.counter }}">
                                            Revision {{ revision.revision }} - by {{ revision.modified_by_user }}, {{ revision.last_modified|naturaltime }}
                                        </button>
                                    </h2>
                                    <div id="collapse-{{ forloop.counter }}"
                                         class="accordion-collapse collapse"
                                         aria-labelledby="heading-{{ forloop.counter }}">
                                        <div class="accordion-body">
                                            <table style="color:#FF0000;">
                                                <tr>
                                                    <td style="padding:2px;
                                                               border-width:1px;
                                                               border-style:solid;
                                                               border-color:#FF0000">
                                                        <b>{{ revision.display_delta }}</b>
                                                    </td>
                                                    <td style="padding:2px;
                                                               border-width:1px;
                                                               border-style:dotted;
                                                               border-color:#FF0000;
                                                               border-left-style:None">{{ revision.text }}</td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            {% empty %}
                                None found
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <br>
    <h2 class="mt-5">Marking tasks</h2>
    <table class="table table-striped table-bordered sortable table-sm table-responsive w-50">
        <thead>
            <tr>
                <th>Paper</th>
                <th>Question index</th>
                <th>Version</th>
                <th>Edition</th>
                <th>Username</th>
                <th>Score</th>
                <th>More information</th>
            </tr>
        </thead>
        <tbody>
            {% for task in marking_tasks %}
                <tr>
                    <td>{{ task.paper.paper_number }}</td>
                    <td>{{ task.latest_annotation.edition }}</td>
                    <td>{{ task.question_index }}</td>
                    <td>{{ task.question_version }}</td>
                    <td>{{ task.assigned_user }}</td>
                    <td>{{ task.latest_annotation.score_str }}</td>
                    <td class="text-center">
                        <a class="btn btn-outline-primary"
                           href="{% url 'progress_marking_task_details' task.pk %}">view task</a>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <br>
    <!-- Edit Modal-->
    <div class="modal fade"
         id="editModal"
         tabindex="-1"
         aria-labelledby="editModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Creating Rubric</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <form action="{% url 'rubric_edit' rubric_key %}" method="post">
                    {% csrf_token %}
                    <div class="modal-body">
                        {{ form.non_field_errors }}
                        <div class="row form-group">
                            <div class="col">
                                {{ form.question.errors }}
                                <label for="{{ form.question.id_for_label }}">Question:</label>
                                {{ form.question }}
                            </div>
                        </div>
                        <div class="row form-group">
                            <div class="col">
                                {{ form.text.errors }}
                                <label for="{{ form.text.id_for_label }}">Rubric Text:</label>
                                {{ form.text }}
                            </div>
                        </div>
                        <div class="row form-group">
                            <div class="col">
                                {{ form.kind.errors }}
                                <label for="{{ form.kind.id_for_label }}">Rubric Kind:</label>
                                {{ form.kind }}
                            </div>
                        </div>
                        <div class="row mt-2">
                            {{ form.value.errors }}
                            <label class="col-sm-2 col-form-label" for="{{ form.value.id_for_label }}">Value:</label>
                            <div class="col">{{ form.value }}</div>
                            <label class="col-sm-2 col-form-label"
                                   for="{{ form.out_of.id_for_label }}"
                                   id="id_out_of_label">out of</label>
                            <div class="col">{{ form.out_of }}</div>
                        </div>
                        <div class="row form-group">
                            <div class="col">
                                {{ form.meta.errors }}
                                <label for="{{ form.meta.id_for_label }}">Rubric Meta (not shown to students):</label>
                                {{ form.meta }}
                            </div>
                        </div>
                        <div class="accordion mt-2" id="accordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingOne">
                                    <button class="accordion-button collapsed"
                                            type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#collapseOne"
                                            aria-controls="collapseOne">Advanced Settings</button>
                                </h2>
                                <div id="collapseOne"
                                     class="accordion-collapse collapse"
                                     aria-labelledby="headingOne"
                                     data-bs-parent="#accordion">
                                    <div class="accordion-body">
                                        <div class="row form-group">
                                            <div class="col">
                                                {{ form.versions.errors }}
                                                <label for="{{ form.meta.id_for_label }}">Versions:</label>
                                                {{ form.versions }}
                                            </div>
                                        </div>
                                        <div class="row form-group">
                                            <div class="col">
                                                {{ form.parameters.errors }}
                                                <label for="{{ form.parameters.id_for_label }}">Parameters:</label>
                                                {{ form.parameters }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <input type="submit" class="btn btn-primary" value="Save">
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock main_content %}
