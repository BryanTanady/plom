<!--
    SPDX-License-Identifier: AGPL-3.0-or-later
    Copyright (C) 2023 Edith Coates
    Copyright (C) 2023 Julian Lapenna
    Copyright (C) 2023 Divy Patel
    Copyright (C) 2023-2024 Colin B. Macdonald
    Copyright (C) 2023-2024 Aden Chan
    Copyright (C) 2023-2024 Aden Chan
-->
{% extends "base/base.html" %}
{% load humanize %}
{% load render_table from django_tables2 %}
{% load humanize %}
{% load render_table from django_tables2 %}
{% block title %}
    Rubrics
{% endblock title %}
{% block page_heading %}
    Rubrics
{% endblock page_heading %}
{% block main_content %}
    <script>
        function populateFields() {
            updateQuestion();
            updateKind();
        }

        function updateQuestion() {
            var question_dict = JSON.parse('{{ questions|escapejs }}');
            var question = document.getElementById("id_question").value;
            var out_of = question_dict[question]["mark"];
            document.getElementById("id_out_of").value = out_of;
            updateConstraints(out_of);

        }

        function updateKind() {
            var kind = document.getElementById("id_kind").value;
            if (kind === "absolute") {
                document.getElementById("id_out_of_label").innerHTML = "out of";
            } else {
                document.getElementById("id_out_of_label").innerHTML = "Max:";
            }
            updateConstraints(document.getElementById("id_out_of").value);
        }

        function updateConstraints(out_of) {
            var kind = document.getElementById("id_kind").value;
            if (kind === "absolute") {
                document.getElementById("id_value").min = 0;
                document.getElementById("id_value").max = out_of;
            } else if (kind === "relative") {
                document.getElementById("id_value").min = -1 * out_of;
                document.getElementById("id_value").max = out_of;
            } else {
                document.getElementById("id_value").value = 0;
            }
        }
    </script>
    <div>
        <a class="btn btn-primary dinline-block"
           href="{% url 'rubrics_admin' %}">Rubric management&hellip;</a>
        <a class="btn btn-primary dinline-block ms-2"
           href="{% url 'rubrics_access' %}">Rubric access controls&hellip;</a>
        <a class="btn btn-primary dinline-block ms-2"
           href="{% url 'feedback_rules' %}">Feedback rules&hellip;</a>
    </div>
    <hr />
    {% comment %} Filter {% endcomment %}
    <div class="row">
        <div class="col">
            <form method="get" action="" class="form-inline">
                <div class="form-group mr-2">
                    {{ rubric_filter_form }}
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-filter"></i> Filter
                    </button>
                </div>
            </form>
        </div>
        <div class="col">
            <button type="submit"
                    class="btn btn-primary float-end"
                    data-bs-toggle="modal"
                    data-bs-target="#createModal"
                    onclick="populateFields()">
                <i class="bi bi-plus-circle-fill"></i> Create Rubric
            </button>
        </div>
    </div>
    {% comment %} Table {% endcomment %}
    <div class="mt-2">{% render_table rubrics %}</div>
    <!-- Create Rubric Modal -->
    <div class="modal fade"
         id="createModal"
         tabindex="-1"
         aria-labelledby="createModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createModalLabel">Creating Rubric</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <form action="{% url 'rubric_create' %}" method="post">
                    {% csrf_token %}
                    <div class="modal-body">
                        {{ rubric_create_form.non_field_errors }}
                        <div class="row form-group">
                            <div class="col">
                                {{ rubric_create_form.question.errors }}
                                <label for="{{ rubric_create_form.question.id_for_label }}">Question:</label>
                                {{ rubric_create_form.question }}
                            </div>
                        </div>
                        <div class="row form-group">
                            <div class="col">
                                {{ rubric_create_form.text.errors }}
                                <label for="{{ rubric_create_form.text.id_for_label }}">Rubric Text:</label>
                                {{ rubric_create_form.text }}
                            </div>
                        </div>
                        <div class="row form-group">
                            <div class="col">
                                {{ rubric_create_form.kind.errors }}
                                <label for="{{ rubric_create_form.kind.id_for_label }}">Rubric Kind:</label>
                                {{ rubric_create_form.kind }}
                            </div>
                        </div>
                        <div class="row mt-2">
                            {{ rubric_create_form.value.errors }}
                            <label class="col-sm-2 col-form-label"
                                   for="{{ rubric_create_form.value.id_for_label }}">Value:</label>
                            <div class="col">{{ rubric_create_form.value }}</div>
                            <label class="col-sm-2 col-form-label"
                                   for="{{ rubric_create_form.out_of.id_for_label }}"
                                   id="id_out_of_label">out of</label>
                            <div class="col">{{ rubric_create_form.out_of }}</div>
                        </div>
                        <div class="row form-group">
                            <div class="col">
                                {{ rubric_create_form.meta.errors }}
                                <label for="{{ rubric_create_form.meta.id_for_label }}">Rubric Meta (not shown to students):</label>
                                {{ rubric_create_form.meta }}
                            </div>
                        </div>
                        <div class="accordion mt-2" id="accordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingOne">
                                    <button class="accordion-button collapsed"
                                            type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#collapseOne"
                                            aria-controls="collapseOne">Advanced Settings</button>
                                </h2>
                                <div id="collapseOne"
                                     class="accordion-collapse collapse"
                                     aria-labelledby="headingOne"
                                     data-bs-parent="#accordion">
                                    <div class="accordion-body">
                                        <div class="row form-group">
                                            <div class="col">
                                                {{ rubric_create_form.versions.errors }}
                                                <label for="{{ rubric_create_form.meta.id_for_label }}">Versions:</label>
                                                {{ rubric_create_form.versions }}
                                            </div>
                                        </div>
                                        <div class="row form-group">
                                            <div class="col">
                                                {{ rubric_create_form.parameters.errors }}
                                                <label for="{{ rubric_create_form.parameters.id_for_label }}">Parameters:</label>
                                                {{ rubric_create_form.parameters }}
                                            </div>
                                        </div>
                                        <div class="row form-group">
                                            <div class="col">
                                                {{ form.pedagogy_tags.errors }}
                                                <label for="{{ form.pedagogy_tags.id_for_label }}">Tags:</label>
                                                {{ form.pedagogy_tags }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <input type="submit" class="btn btn-primary" value="Create">
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock main_content %}
