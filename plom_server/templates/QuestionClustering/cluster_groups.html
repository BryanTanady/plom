{% extends "base/base.html" %}
{% load static %}
{% load custom_tags %}
{% block title %}Cluster groups for {{ question_label }} V{{ version }} Page {{ page_num }}{% endblock %}
{% block page_heading %}Cluster groups for {{ question_label }} V{{ version }} Page {{ page_num }}{% endblock %}
{% block main_content %}
    <!-- navigation button -->
    <div class="mb-3">
        <a class="btn btn-success"
           href="{% url 'question_clustering_jobs_home' %}">
            <i class="bi bi-chevron-left"></i>
            Return to question clustering jobs page
        </a>
    </div>
    <!-- Alpine-managed container -->
    <div x-data="{ selected: [], all: false, action: '', ids: [
        {% for cid in cluster_groups.keys %}
            '{{ cid }}'
            {% if not forloop.last %},{% endif %}
        {% endfor %}
        ] }" class="space-y-4">
        <!-- Bulk-action toolbar (always visible) -->
        <div class="fixed top-20 left-1/2 transform -translate-x-1/2 shadow-md rounded p-3 flex items-center space-x-4 z-50">
            <span class="font-medium text-gray-700">
                <strong x-text="selected.length"></strong> selected
            </span>
            <div class="d-flex align-items-center">
                <!-- MERGE form -->
                <form action="{% url 'merge_clusters' %}"
                      method="post"
                      class="d-inline-flex align-items-center me-3">
                    {% csrf_token %}
                    <input type="hidden" name="question_idx" value="{{ question_idx }}">
                    <input type="hidden" name="version" value="{{ version }}">
                    <template x-for="id in selected" :key="id">
                        <input type="hidden" name="selected_clusters" :value="id" />
                    </template>
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button type="submit"
                            class="btn btn-primary"
                            :disabled="selected.length < 2"
                            hx-include="input[name='selected_clusters']:checked"
                            onclick="return confirm('Are you sure merging the selected clusters?');">
                        Merge Selected
                    </button>
                </form>
                <!-- DELETE form -->
                <form action="{% url 'bulk_delete_clusters' %}"
                      method="post"
                      class="d-inline-flex align-items-center">
                    {% csrf_token %}
                    <input type="hidden" name="question_idx" value="{{ question_idx }}">
                    <input type="hidden" name="version" value="{{ version }}">
                    <template x-for="id in selected" :key="id">
                        <input type="hidden" name="selected_clusters" :value="id" />
                    </template>
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button type="submit"
                            class="btn btn-danger"
                            :disabled="selected.length == 0"
                            hx-include="input[name='selected_clusters']:checked"
                            onclick="return confirm('Are you sure deleting the selected clusters?');">
                        Delete Selected
                    </button>
                </form>
            </div>
        </div>
        {% include "../base/alert_messages.html" with messages=messages %}
        <!-- form with hidden action -->
        <form x-ref="form" method="post">
            {% csrf_token %}
            <input type="hidden" name="action" x-model="action" />
            <table class="table table-striped table-bordered table-sm mx-auto">
                <thead class="bg-gray-100">
                    <tr">
                        <th class="text-center">
                            <input type="checkbox"
                                   class="form-check-input"
                                   x-model="all"
                                   @change="selected = all ? ids : []">
                        </th>
                        <th class="text-center">Preview</th>
                        <th class="text-center">ClusterId</th>
                        <th class="text-center">Counts</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for clusterId, count in cluster_groups.items %}
                        <tr :class="{ 'table-primary': selected.includes('{{ clusterId }}') }">
                            <td class="text-center align-middle">
                                <input type="checkbox"
                                       name="selected_clusters"
                                       value="{{ clusterId }}"
                                       class="form-check-input"
                                       x-model="selected">
                            </td>
                            <td class="align-middle">
                                {% with papers=cluster_to_paper_map|get_item:clusterId %}
                                    {% if papers %}
                                        {% with pn=papers.0 %}
                                            <img src="{% url 'extracted_rectangle' pn version page_num %}?left={{ left }}&top={{ top }}&right={{ right }}&bottom={{ bottom }}"
                                                 class="img-fluid rounded mx-auto d-block"
                                                 style="max-height:100px"
                                                 loading="lazy"
                                                 alt="cluster {{ clusterId }} preview"
                                                 onerror="imgError(this)">
                                        {% endwith %}
                                    {% endif %}
                                {% endwith %}
                            </td>
                            <td class="text-center align-middle">{{ clusterId }}</td>
                            <td class="text-center align-middle">{{ count }}</td>
                            <td class="align-middle text-center">
                                <a class="btn btn-success btn-sm"
                                   href="{% url 'clustered_papers' question_idx version page_num clusterId %}">View members</a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </form>
    </div>
    <script>
    // image error fallback
    function imgError(image) {
      const span = document.createElement('span');
      span.classList.add("alert","alert-warning","mx-2","py-0");
      span.innerText = "Could not extract rectangle.";
      image.parentNode.insertBefore(span, image);
      image.remove();
    }
    </script>
{% endblock %}
{% block extra_scripts %}
    <script defer
            src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
{% endblock %}
