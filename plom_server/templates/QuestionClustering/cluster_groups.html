{% extends "base/base.html" %}
{% load static %}
{% load custom_tags %}
{% block title %}Cluster groups for {{ question_label }} V{{ version }} Page {{ page_num }}{% endblock %}
{% block page_heading %}Cluster groups for {{ question_label }} V{{ version }} Page {{ page_num }}{% endblock %}
{% block main_content %}
    <!-- navigation button -->
    <div class="mb-3">
        <a class="btn btn-success"
           href="{% url 'question_clustering_jobs_home' %}">
            <i class="bi bi-chevron-left"></i>
            Return to question clustering jobs page
        </a>
    </div>
    <!-- Include SortableJS + Alpine + Tablesort -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script defer
            src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tablesort@5.2.1/dist/tablesort.min.js"></script>
    <div x-data="{ selected: [], all: false, ids: [
        {% for cid in cluster_groups.keys %}
            '{{ cid }}'
            {% if not forloop.last %},{% endif %}
        {% endfor %}
        ] }" x-init=" Sortable.create($refs.tbody, { handle: '.drag-handle', animation: 150, draggable: 'tr' }); new Tablesort($refs.clusterTable); " class="space-y-4">
        <!-- Bulk-action toolbar -->
        <div class="fixed top-20 left-1/2 transform -translate-x-1/2 shadow-md rounded p-3 flex items-center space-x-4 z-50">
            <span class="font-medium text-gray-700">
                <strong x-text="selected.length"></strong> selected
            </span>
            <div class="d-flex align-items-center">
                <!-- Merge form -->
                <form action="{% url 'merge_clusters' %}"
                      method="post"
                      class="d-inline-flex align-items-center me-3">
                    {% csrf_token %}
                    <input type="hidden" name="question_idx" value="{{ question_idx }}">
                    <input type="hidden" name="version" value="{{ version }}">
                    <template x-for="id in selected" :key="id">
                        <input type="hidden" name="selected_clusters" :value="id" />
                    </template>
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button type="submit"
                            class="btn btn-primary"
                            :disabled="selected.length < 2"
                            onclick="return confirm('Are you sure merging?');">Merge Selected</button>
                </form>
                <!-- Delete form -->
                <form action="{% url 'bulk_delete_clusters' %}"
                      method="post"
                      class="d-inline-flex align-items-center">
                    {% csrf_token %}
                    <input type="hidden" name="question_idx" value="{{ question_idx }}">
                    <input type="hidden" name="version" value="{{ version }}">
                    <template x-for="id in selected" :key="id">
                        <input type="hidden" name="selected_clusters" :value="id" />
                    </template>
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button type="submit"
                            class="btn btn-danger"
                            :disabled="selected.length == 0"
                            onclick="return confirm('Are you sure deleting?');">Delete Selected</button>
                </form>
            </div>
        </div>
        {% include "../base/alert_messages.html" with messages=messages %}
        <form x-ref="form" method="post">
            {% csrf_token %}
            <table x-ref="clusterTable"
                   class="table table-striped table-bordered table-sm mx-auto">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="text-center">
                            <input type="checkbox"
                                   class="form-check-input"
                                   x-model="all"
                                   @change="selected = all ? ids : []">
                        </th>
                        <th class="text-center" data-sort-method="none">Preview</th>
                        <th class="text-center" data-sort-method="number">
                            <span class="d-flex justify-content-center align-items-center gap-1">
                                ClusterId
                                <i class="sort-icon bi bi-chevron-expand" aria-hidden="true"></i>
                            </span>
                        </th>
                        <th class="text-center" data-sort-method="number">
                            <span class="d-flex justify-content-center align-items-center gap-1">
                                Counts
                                <i class="sort-icon bi bi-chevron-expand" aria-hidden="true"></i>
                            </span>
                        </th>
                        <th class="text-center" data-sort-method="none">Actions</th>
                        <th class="text-center" data-sort-method="none">&nbsp;</th>
                    </tr>
                </thead>
                <tbody x-ref="tbody">
                    {% for clusterId, count in cluster_groups.items %}
                        <tr :class="{ 'table-primary': selected.includes('{{ clusterId }}') }">
                            <td class="text-center align-middle">
                                <input type="checkbox"
                                       name="selected_clusters"
                                       value="{{ clusterId }}"
                                       class="form-check-input"
                                       x-model="selected">
                            </td>
                            <td class="align-middle">
                                {% with papers=cluster_to_paper_map|get_item:clusterId %}
                                    {% if papers %}
                                        {% with pn=papers.0 %}
                                            <img src="{% url 'extracted_rectangle' pn version page_num %}?left={{ left }}&top={{ top }}&right={{ right }}&bottom={{ bottom }}"
                                                 class="img-fluid rounded mx-auto d-block"
                                                 style="max-height:100px"
                                                 loading="lazy"
                                                 alt="cluster {{ clusterId }}"
                                                 onerror="imgError(this)">
                                        {% endwith %}
                                    {% endif %}
                                {% endwith %}
                            </td>
                            <td class="text-center align-middle">{{ clusterId }}</td>
                            <td class="text-center align-middle">{{ count }}</td>
                            <td class="align-middle text-center">
                                <a class="btn btn-success btn-sm"
                                   href="{% url 'clustered_papers' question_idx version page_num clusterId %}">
                                    View members
                                </a>
                            </td>
                            <td class="text-center align-middle drag-handle" style="cursor:move;">
                                <i class="bi bi-list"></i>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button type="submit" class="btn btn-primary mt-3">Save Order</button>
        </form>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
      const table = document.querySelector('[x-ref="clusterTable"]');
      // initialize all to the expand icon
      table.querySelectorAll('.sort-icon').forEach(icon => {
        icon.classList.remove('bi-chevron-up', 'bi-chevron-down');
        icon.classList.add('bi-chevron-expand');
      });
      // swap on sort
      table.addEventListener('afterSort', () => {
        table.querySelectorAll('th').forEach(th => {
          const icon = th.querySelector('.sort-icon');
          if (!icon) return;
          icon.classList.remove('bi-chevron-up', 'bi-chevron-down', 'bi-chevron-expand');
          const dir = th.getAttribute('aria-sort');
          if (dir === 'ascending') {
            icon.classList.add('bi-chevron-up');
          } else if (dir === 'descending') {
            icon.classList.add('bi-chevron-down');
          } else {
            icon.classList.add('bi-chevron-expand');
          }
        });
      });
    });

    function imgError(image) {
      const span = document.createElement('span');
      span.classList.add("alert", "alert-warning", "mx-2", "py-0");
      span.innerText = "Could not extract rectangle.";
      image.parentNode.insertBefore(span, image);
      image.remove();
    }
    </script>
{% endblock %}
