<!--
    SPDX-License-Identifier: AGPL-3.0-or-later
    Copyright (C) 2023 Divy Patel
    Copyright (C) 2023 Colin B. Macdonald
    Copyright (C) 2023 Andrew Rechnitzer
-->
{% extends "base/base.html" %}
{% load static %}
{% load humanize %}
{% block title %}
    Marking task info
{% endblock title %}
{% block page_heading %}
    Marking task info
    <a class="btn btn-primary"
       href="{% url 'progress_marking_task_filter' %}?question={{ question }}&version={{ version }}">browse marking</a>
{% endblock page_heading %}
{% block main_content %}
    <div class="container p-2 border rounded mx-0">
        <div class="row m-2">
            <div class="col">
                <p>Paper: {{ paper_number }}</p>
                <p>Question: {{ question }}</p>
                <p>Version: {{ version }}</p>
                <p>Status: {{ status }}</p>
                {% if status == "Complete" %}
                    <p>Score: {{ score }}</p>
                    <p>Edition: {{ edition }}</p>
                    <p>User: {{ username }}</p>
                    <p>Last update: {{ last_update|naturaltime }}</p>
                    <p>Marking time: {{ marking_time }}s</p>
                {% elif status == "Out" %}
                    <p>User: {{ username }}</p>
                {% elif status == "To Do" %}
                {% else %}
                {% endif %}
                <p>
                    <button hx-get="{% url 'progress_original_img_wrap' paper_number question %}"
                            hx-target="#imageHere"
                            hx-replace="innerHTML"
                            class="btn btn-outline-info">show original</button>
                    {% if status == "Complete" %}
                        <button hx-get="{% url 'progress_annotation_img_wrap' paper_number question %}"
                                hx-target="#imageHere"
                                hx-replace="innerHTML"
                                class="btn btn-outline-success">show annotation</button>
                    {% endif %}
                </p>
                {% if user_is_manager %}
                    <div>
                        <span class="dropdown">
                            <button class="btn btn-warning dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false">reassign</button>
                            <ul class="dropdown-menu">
                                {% for user in lead_markers %}
                                    <li class="p-2">
                                        <span hx-confirm="This will reassign the task and latest annotations to the given user. Are you sure you wish to proceed?"
                                              hx-patch=""
                                              class="badge text-bg-warning fs-6 align-middle rounded dropdown-item py-2"><i class="bi bi-arrow-right-square pe-2"></i>{{ user.username }}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        </span>
                        <button class="btn btn-danger disabled">reset</button>
                        <p>
                            <b>NOTE</b>:
                            <ul>
                                <li>
                                    The reset and reassign buttons are currently disabled. We don't have code to do this yet. We need to decide some stuff first.
                                </li>
                            </ul>
                        </p>
                    </div>
                {% endif %}
            </div>
            <div class="col-auto">
                <div id="imageHere"></div>
            </div>
        </div>
        <div class="row m-2">
            <h3>Tags</h3>
            <div class="m-2 p-2">
                <span class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">add tag</button>
                    <ul class="dropdown-menu">
                        {% for tag in addable_tags_not_attn %}
                            <li class="p-2">
                                <span hx-patch="{% url 'marking_task_tag' task_pk tag.pk %}"
                                      class="badge bg-success fs-6 align-middle rounded-pill dropdown-item py-2"><i class="bi bi-plus-square pe-2"></i>{{ tag.text }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                </span>
                {% for tag in tags_not_attn_marker %}
                    <span class="badge bg-primary fs-6 align-middle rounded-pill">{{ tag.text }}
                        <button hx-delete="{% url 'marking_task_tag' task_pk tag.pk %}"
                                class="btn btn-primary p-1">
                            <i class="bi bi-backspace"></i>
                        </button>
                    </span>
                {% endfor %}
            </div>
            <h4>Attention user tags</h4>
            <div class="m-2 p-2">
                <span class="dropdown">
                    <button class="btn btn-warning dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">flag to user</button>
                    <ul class="dropdown-menu">
                        {% for user in addable_attn_markers %}
                            <li class="p-2">
                                <!-- we add the vars here to get this hx-post to look like a form post -->
                                <span hx-post="{% url 'create_marking_task_tag' task_pk %}"
                                      hx-vars="newTagText: '@{{ user.username }}'"
                                      class="badge text-bg-warning fs-6 align-middle rounded-pill dropdown-item py-2"><i class="bi bi-plus-square pe-2"></i>@{{ user.username }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                </span>
                {% for tag in tags_attn_marker %}
                    <span class="badge text-bg-warning fs-6 align-middle rounded-pill">{{ tag.text }}
                        <button hx-delete="{% url 'marking_task_tag' task_pk tag.pk %}"
                                class="btn btn-warning p-1">
                            <i class="bi bi-backspace"></i>
                        </button>
                    </span>
                {% endfor %}
            </div>
        </div>
        {% if status == "Complete" %}
            <div class="row m-2">
                <h3>Rubrics used in latest annotation</h3>
                <table class="table table-striped table-bordered sortable table-sm table-responsive w-auto">
                    <thead>
                        <tr>
                            <th>Rubric-key</th>
                            <th>Question</th>
                            <th>Kind</th>
                            <th>Display Delta</th>
                            <th>Text</th>
                            <th>More details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rubric in rubrics %}
                            <tr>
                                <td>{{ rubric.key }}</td>
                                <td>{{ rubric.question }}</td>
                                <td>{{ rubric.kind }}</td>
                                <td>{{ rubric.display_delta }}</td>
                                <td>{{ rubric.text }}</td>
                                <td class="text-center">
                                    <a class="btn btn-outline-primary"
                                       href="{% url 'rubric_item' rubric.key %}">info</a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
    </div>
{% endblock main_content %}
