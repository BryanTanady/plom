<!--
    SPDX-License-Identifier: AGPL-3.0-or-later
    Copyright (C) 2023 Andrew Rechnitzer
    Copyright (C) 2024 Bryan Tanady
-->
{% extends "base/base.html" %}
{% load static %}
{% block title %}
    Build Student Report pdfs
{% endblock title %}
{% block page_heading %}
    Build Student Report pdfs
{% endblock page_heading %}
{% block main_content %}
    <div class="card w-75">
        <div class="card-title">
            <button hx-post="{% url 'build_all_reports' %}"
                    href=""
                    class="btn btn-success m-2">Build all reports (incl outdated)</button>
            <button hx-delete="{% url 'build_report_cancel_queued' %}"
                    class="btn btn-warning m-2">Cancel queued</button>
            <button hx-delete="{% url 'build_all_reports' %}" class="btn btn-danger m-2">Delete all</button>
        </div>
        <div class="card-body">
            <ul>
                <li>{{ n_papers }} scanned papers</li>
                {% if n_not_ready %}
                    <li>
                        <i class="bi bi-exclamation-diamond-fill text-warning"></i>{{ n_not_ready }} scanned papers not yet ready for report building
                    </li>
                {% endif %}
                <li>{{ n_ready }} papers ready for report building (identified and marked but reports are not yet built)</li>
                {% if n_complete == n_papers %}
                    <li>
                        <i class="bi bi-check-circle text-success"></i> all reports built
                    </li>
                {% else %}
                <!-- TODO: N_COMPLETE IS DIFF HERE -->
                    <li>{{ n_complete }} papers have report built</li>
                {% endif %}
                {% if n_outdated %}
                    <li>
                        <i class="bi bi-exclamation-diamond-fill text-danger"></i>
                        {{ n_outdated }}built reports are out of date
                    </li>
                {% endif %}
                {% if n_queued %}
                    <li>
                        <i class="bi bi-clock-history text-info"></i>{{ n_queued }} reports queued for building
                        <a href="{% url 'build_student_report' %}"
                           class="btn btn-info m-4"
                           id="reload_button">reload page</a>
                        (page will auto-reload after 30s)
                    </li>
                {% endif %}
                {% if n_errors %}
                    <li>
                        <i class="bi bi-exclamation-diamond-fill text-danger"></i> {{ n_errors }} errors in report building
                    </li>
                {% endif %}
            </ul>
            {% if n_outdated %}
                <a href="{% url 'build_all_reports' %}" class="btn btn-danger">Download zip of student reports</a> some papers outdated
            {% elif n_complete == n_papers %}
                <a href="{% url 'build_all_reports' %}" class="btn btn-success">Download zip of student reports</a>
            {% elif n_complete %}
                <a href="{% url 'build_all_reports' %}" class="btn btn-warning">Download zip of student reports</a>
                warning - not all reports built
            {% endif %}
        </div>
    </div>
    <div class="card">
        <div class="card-body">
            <table class="table table-striped">
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Identified</th>
                    <th scope="col">Marked</th>
                    <th scope="col">Last updated</th>
                    <th scope="col">Build Status</th>
                    <th scope="col">When Built</th>
                    <th scope="col">Action</th>
                </tr>
                {% for row in papers %}
                    {% if row.scanned %}
                        <tr style="{% if row.obsolete %} text-decoration: line-through;
                                   {% endif %}">
                            <td>{{ row.paper_num }}</td>
                            <td>
                                {% if row.identified %}
                                    <i class="bi bi-check-circle text-success"></i> {{ row.student_id }}
                                {% else %}
                                    <i class="bi bi-exclamation-diamond-fill text-warning"></i>
                                {% endif %}
                            </td>
                            <td>
                                {% if row.marked %}
                                    <i class="bi bi-check-circle text-success"></i> all
                                {% else %}
                                    {% if row.number_marked == 0 %}
                                        <i class="bi bi-exclamation-diamond-fill text-danger"></i> none
                                    {% else %}
                                        <i class="bi bi-exclamation-diamond-fill text-warning"></i> {{ row.number_marked }}
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>{{ row.last_update_humanised }}</td>
                            <!-- Note: uses the symbolic constants defined in HueyTaskTracker -->
                            <td>
                                {% if row.identified and row.marked %}
                                    {% if row.build_report_status == "Starting" or row.build_report_status == "Queued" or row.build_report_status == "Running" %}
                                        <i class="bi bi-clock-history text-info"></i>
                                    {% elif row.build_report_status == "Error" %}
                                        <i class="bi bi-exclamation-diamond-fill text-danger"></i>
                                    {% elif row.build_report_status == "Complete" %}
                                        <i class="bi bi-check-circle text-success"></i>
                                    {% endif %}
                                    {{ row.build_report_status }}
                                {% else %}
                                    <i class="bi bi-exclamation-diamond-fill text-warning"></i> not ready
                                {% endif %}
                            </td>
                            <td>
                                {% if row.build_report_time %}
                                    {% if row.outdated %}
                                        <i class="bi bi-exclamation-diamond-fill text-danger"> outdated </i>
                                    {% else %}
                                        {{ row.build_report_time_humanised }}
                                    {% endif %}
                                {% else %}
                                    <!-- n/a -->
                                {% endif %}
                            </td>
                            <td>
                                {% if row.build_report_time %}
                                    {% if row.outdated %}
                                        <a href="{% url 'build_one_report' row.paper_num %}"
                                           target="_blank"
                                           class="btn btn-warning"><i class="bi bi-exclamation-diamond-fill">view</i></a>
                                        <button hx-put="{% url 'build_one_report' row.paper_num %}"
                                                class="btn btn-warning">
                                            <i class="bi bi-exclamation-diamond-fill">
                                                rebuild report
                                            </i>
                                        </button>
                                        <button hx-delete="{% url 'build_one_report' row.paper_num %}"
                                                class="btn btn-success">delete</button>
                                    {% else %}
                                        <a href="{% url 'build_one_report' row.paper_num %}"
                                           target="_blank"
                                           class="btn btn-success">view</a>
                                        <button hx-delete="{% url 'build_one_report' row.paper_num %}"
                                                class="btn btn-warning">delete</button>
                                    {% endif %}
                                {% else %}
                                    {% if row.identified and row.marked and row.build_report_status != "Starting" and row.build_report_status != "Queued" and row.build_report_status != "Running" %}
                                        <button hx-post="{% url 'build_one_report' row.paper_num %}"
                                                class="btn btn-success">build report</button>
                                    {% else %}
                                        <!-- n/a -->
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
            </table>
        </div>
    </div>
    {% if n_queued %}
        <!-- reload page after 30s if any queued papers -->
        <script>setTimeout("location.reload(true);",30000);</script>
    {% endif %}
{% endblock main_content %}
